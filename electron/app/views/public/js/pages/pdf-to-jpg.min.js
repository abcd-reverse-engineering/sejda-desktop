$(function(){function e(e,a,n){var i=parseInt(e.attr("data-page")),o=e.attr("data-file-counter"),r="png"==a?"image/png":"image/jpeg",s="png"==a?1:.8,d=parseInt(t.find(".active [name=resolution]").val()),l=d/72;if("undefined"!=typeof i&&"undefined"!=typeof o){var c=PdfFilesCache.get(o);if(c){var f=c.pdf,p=(c.file,document.createElement("canvas"));f.getPage(i).then(function(a){var t=a.getViewport({scale:l}),i=p.getContext("2d");p.height=t.height,p.width=t.width;var o={canvasContext:i,viewport:t},d=a.render(o);return d.promise.then(function(){p.toBlob(function(e){n(null,URL.createObjectURL(e))},r,s),a.cleanup(),a=null,e.addClass("saved")},function(e){n(e),a.cleanup(),a=null})})}else console.log("Cant render",i,o,"nothing found in cache")}}function a(){var a=t.find(".active [name=imageFormat]").val(),n="Save as "+a.toUpperCase();$(".pdf-page-wrap").each(function(){var t=$(this);if(t.find(".save-as-image-wrap").remove(),!a.startsWith("tiff")){var i=t.attr("data-page"),o=decodeURIComponent(t.attr("data-filename"));o.toLowerCase().endsWith(".pdf")&&(o=o.dropRight(4));var r=$('<div class="save-as-image-wrap"><div class="btn-group"><a title="Convert this page to an image" class="btn save-as-image-btn page-tools-btn btn-xs btn-secondary"><i class="fal fa-arrow-down"></i> '+n+"</a></div></div>"),s=r.find("a");s.attr("download",o+"-"+i+"."+a);var d=s.html();s.click(function(n){return n.stopPropagation(),!s.attr("disabled")&&(!!s.attr("href")||(s.html('<i class="fal fa-spinner fa-pulse"></i> Converting...').attr("disabled","disabled"),e(t,a,function(e,a){e?showAlert("Failed to convert to image","danger"):(s.attr("href",a),setTimeout(function(){s.get(0).click(),s.removeAttr("href"),URL.revokeObjectURL(a)},100)),s.html(d).removeAttr("disabled")}),n.preventDefault(),!1))}),t.append(r)}}),$(".save-as-image-btn").tooltip(tooltipOpts)}var t=$(".task-form"),n=0;$(document).on("pagesRendered",function(e,t){a(),PdfFiles.getDocument(t.files[0],function(e){n=e.numPages})}),$("#convertSelectedBtn").click(function(e){var a=$(".pdf-page-wrap.selected").length;0===a?(t.find("[name=allPages]").val("true"),a=n):t.find("[name=allPages]").val("false")}),$(document).on("change","input:radio[name=imageFormat]",function(){setTimeout(function(){a()},100)}),$(document).on("mouseenter",".pdf-page-wrap",function(e){$(this).find(".save-as-image-btn").removeClass("btn-secondary")}),$(document).on("mouseleave",".pdf-page-wrap",function(){$(this).find(".save-as-image-btn").addClass("btn-secondary")})});
$(function(){function e(e){var t=y.find(".pdf-page-wrap");e&&(t=t.filter(e)),t.remove(),$(document).trigger("pdfPagesDeleted")}function t(){var e=y.attr("data-prev-selected-page"),t=y.attr("data-prev-selected-file"),a=y.find(".pdf-page-wrap").filter("[data-page="+e+"][data-file-counter="+t+"]").first();return 0==a.length&&(a=y.find(".pdf-page-wrap").first()),a}function a(){var e=y,t=e.children("li.selected");if(t.length>0){for(var a=t.get().length,n=0;n<a-1;n++){var r=t.get()[n],o=$(r).next("li");if(!o.hasClass("selected"))return void showAlert("Can only reorder consecutive pages. Please review your page selection.")}var i=t.get()[a-1],d=t.get().slice(0,a-1);$(i).after(d.reverse())}else t=e.children("li"),e.append(t.get().reverse())}function n(){const e=y.find(".pdf-page-wrap").first(),t=e.outerHeight(),a=$('<style id="addMarkHeightCss">.add-mark { height: '+t+"px; </style>");$("#addMarkHeightCss").remove(),$("body").append(a)}function r(){return b.find(".file-page-selector").filter(":visible")}function o(t){var a=$(".dropdown-menu.file-page-selector-opts"),n=t.counter,r=$('<li><a href="javascript://">'+t.basename.truncateMiddle(30)+"</a></li>");r.click(function(){s(t)}),a.append(r),$(".dropdown-menu.clear-opts").append($('<li><a href="javascript://">Keep only: '+t.basename.truncateMiddle(30)+"</a></li>").click(function(){if(e(":not([data-file-counter="+n+"])"),!d()){var t=M[0];M.length>1&&t.counter===n&&(t=M[1]),s(t)}}));var o=$('<div class="file-page-selector pdf-page-wrap-parent noselect" style="display:none"></div>');o.attr("data-file-counter",t.counter),o.attr("data-filename",encodeURIComponent(t.name)),b.append(o),y.find(".pdf-page-wrap[data-file-counter="+n+"]").cloneWithCanvas().appendTo(o),o.scrollStopped(function(){l()});var i=o;i.find(".pdf-page-wrap").addClass("grabbable");var c=y;i.multisortable({items:"> .grabbable",scroll:!0,connectWith:c,scrollSensitivity:100,receive:function(e,t){console.log("multisortable.start receive")},start:function(e,t){console.log("multisortable.start sidebar"),i.cancelled=!1,c.find(".pdf-page-wrap").removeClass("selected ui-multisort-grouped");var a=$(t.item);t.item.hasClass("ui-multisort-grouped")&&(a=i.find(".ui-multisort-grouped").not(".ui-sortable-placeholder"),a.each(function(e){$(this).attr("data-sort",e)})),a.addClass("dragged").find(".magnified").hide()},beforeStop:function(e,t){if(console.log("multisortable.beforeStop sidebar"),i.find(".ui-sortable-placeholder").length>0)return i.cancelled=!0,i.multisortable("cancel"),!1},stop:function(e,t){if(console.log("multisortable.stop sidebar"),t.item.removeClass("dragged used"),i.cancelled)return i.find(".ui-sortable-helper").remove(),void console.log("multisortable cancelled");if(t.item.hasClass("ui-multisort-grouped")){var a=i.find(".ui-multisort-grouped");a.removeClass("dragged used selected ui-multisort-grouped");var n=a.not(t.item);n.cloneWithCanvas().addClass("selected ui-multisort-grouped").insertBefore($(t.item)).show();var r=$(y.find(".ui-multisort-grouped").get().reverse());r.each(function(){for(var e=$(this),t=parseInt(e.attr("data-sort")),a=e.prev(".ui-multisort-grouped"),n=parseInt(a.attr("data-sort"));t<n;)e.detach().insertBefore(a),a=e.prev(".ui-multisort-grouped"),n=parseInt(a.attr("data-sort"))})}t.item.cloneWithCanvas().appendTo(i).show().removeClass("dragged used selected ui-multisort-grouped ui-multisort-handle"),p(),f(),$(document).trigger("pagesRendered",{files:[],$elem:y})}}),i.disableSelection()}function i(){b.css("width",0),k.css("margin-left",""),$("body").removeClass("with-side-bar"),$(".tools-menu,.bottom-fixed").css("left",0),b.hide()}function d(){return b.is(":visible")}function s(e){b.find(".file-page-selector").hide();var t=b.find(".file-page-selector[data-file-counter="+e.counter+"]"),a=e.name;C.find(".filename").text(a.truncateMiddle(25)).attr("title",a),b.show(),t.show(),f();var n=t.find(".pdf-page").filter(":visible").get(0).getBoundingClientRect().width;c(n),l()}function l(){setTimeout(function(){$(document).trigger("renderVisiblePageThumbs")},500)}function c(e){var t=2*(parseInt(e)+41)+20;b.css("width",t+"px"),k.css("margin-left",t+"px"),$("body").addClass("with-side-bar"),$(".tools-menu,.bottom-fixed").css("left",t+"px")}function p(){var e=r(),t=e.find(".pdf-page-wrap").detach().get();t=_.sortBy(t,function(e){return parseInt($(e).attr("data-page"))}),$(t).appendTo(e)}function f(){var e=r();e.find(".pdf-page-wrap").removeClass("used").show(),y.find(".pdf-page-wrap").each(function(){var t=$(this).attr("data-page"),a=$(this).attr("data-file-counter");e.find("[data-page="+t+"][data-file-counter="+a+"]").addClass("used")})}function u(){var e="true"!==$("body").attr("data-pro-user"),t=y.find(".pdf-page-wrap").length>50;return!(!e||!t)&&(showUpgradePopupHint("free-pages-per-task"),!0)}function g(){var e=u();e||setTimeout(g,2e3)}window.globalPdfRenderOpts={useLetterPrefix:!0};var m=$("#tools-menu");$(window).scroll(function(){var e=$(this).scrollTop();e<270?m.css({position:""}).removeClass("fixed"):m.css({position:"fixed",top:0}).addClass("fixed")});const v=$("#globalBtns");v.detach().appendTo(m).show();var h={};$(document).on("fileUploadFailed",function(e,t){h[t.counter]=t});var w=0;$(".task-form");$(document).on("fileUploadStarted",function(e,t){w++,Sejda.UnsavedWork.markUnsavedWork()});var b=$("#file-page-selector-wrap"),C=$("#file-page-selector-header"),k=$("#body-wrap");b.insertBefore(k);const y=$("#pdf-canvas-list");$("#removeAllPagesBtn").click(function(t){t.preventDefault(),e(),d()||s(M[0])}),$("#removeSelectedPagesBtn").click(function(t){t.preventDefault(),e(".selected")}),$(document).on("click",".add-blank-page-btn",function(e){e.preventDefault();const a=$(this).parents("[data-insert-at]").attr("data-insert-at"),n=Sejda.Utils.parseInsertAt(a,y),r=n.page||t();if(0===r.length)return void Raven.captureMessage("Could not determine where to insert blank page");const o=r.cloneWithCanvas();o.attr("data-filename","blank_page").attr("data-file-counter","-1").attr("data-page","-1"),o.find(".pdf-page-number").attr("title",s_i18n("New blank page")).text(""),o.removeClass("ui-sortable-handle selected ui-multisort-grouped"),o.attr("id","pdfPageWrap_Blank"+Date.now()),o.find(".magnified").remove(),o.clearCanvases(),n.insertAfter?o.insertAfter(r):o.insertBefore(r)}),$(".reorder-opts a").click(function(e){e.preventDefault();var t=$(this);"last-first"==t.attr("data-reorder-mode")&&a(),l()}),$(document).on("thumbSizeChanged",function(e,t){n()}),$(document).on("pdfPageRenderedLazy",function(e,t){1===t.pageNum&&n()});const P=$("#addMarkDropdownMenu");$("body").append(P.parent("section").detach()),$(document).on("click",function(e){P.hide()});const B=$("#addMoreFilesBtn"),x=$("#addMorePagesBtn");$(document).on("mouseover","#addMoreFilesBtn",function(){B.append($("#add-files-moving-menu").detach().css("display","")),P.hide()}),$(document).on("mouseover","#addMorePagesBtn",function(){x.append($("#add-pages-moving-menu").detach().css("display","")),P.hide()}),$(document).on("click",".add-mark .fal",function(e,t){const a=$(this),n=e.pageY-15;var r=e.pageX-10;const o=P.width(),i=window.innerWidth;P.find(".dropdown-submenu").removeClass("pulled-left"),r+2*o>i&&(P.find(".dropdown-submenu").addClass("pulled-left"),r+o>i&&(r=i-o-10)),P.find(".add-files-menu-item").append($("#add-files-moving-menu").detach()),P.find(".add-pages-menu-item").append($("#add-pages-moving-menu").detach());const d=a.parents(".add-mark"),s=[d.parents(".pdf-page-wrap").attr("id"),d.hasClass("before")?"before":"after"].join(":");return P.attr("data-insert-at",s),P.css({top:n+20,left:r+15}).show(),e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault(),!1});var M=[];const S=$("#pdf-canvas-wrap");$(document).on("pagesRendered",function(e,t){M=M.concat(t.files),t.files.forEach(function(e){o(e)}),S.hide();const a=y.find(".pdf-page-wrap");a.each(function(e){const t=$(this);if(!(t.find(".add-mark").length>0)){const a=$('<div class="add-mark"><i class="fal fa-plus-circle"></i></div>'),n=t.attr("id");a.attr({"data-parent":n,"data-page":t.attr("data-page")}).addClass("after"),a.insertAfter(t.find("canvas"));const r=a.clone();r.removeClass("after").addClass("before"),t.prepend(r)}}),y.show(),S.show(),l()}),$(document).hoverIntent({interval:0,timeout:400,over:function(){const e=$(this);P.find(".dropdown-submenu .dropdown-menu").hide(),e.find(".dropdown-menu").show()},out:function(){const e=$(this);e.find(".dropdown-menu").hide()},selector:".dropdown-submenu"}),$("#emptyPlaceholder").find("li.empty").prependTo(y),$("#file-page-selector-opts-select-all").click(function(e){e.preventDefault();var t=r();t.find(".pdf-page-wrap").addClass("selected ui-multisort-grouped")}),$("#file-page-selector-opts-select-none").click(function(e){e.preventDefault();var t=r();t.find(".pdf-page-wrap").removeClass("selected ui-multisort-grouped")}),C.find(".close").click(function(){i()}),$("#openComposerBtn").click(function(){s(M[0])}),$(document).on("thumbSizeChanged",function(e,t){d()&&c(t.width)}),$(document).on("pdfPageRendered",function(e,t){var a=$(".pdf-page-wrap").filter(function(){return $(this).attr("data-file-counter")==t.file.counter&&$(this).attr("data-page")==t.pageNum}),n=h[t.file.counter];if(n)return a.remove();var r=a.find(".pdf-page-number"),o=t.file.name.slice(0,-4);r.text(t.pageNum+" of "+o.truncateMiddle(25)).attr("title","Page "+t.pageNum+" of "+t.file.name)}),$(document).on("pdfPagesReordered pdfPagesDeleted",function(){f()}),$(document).on("filesSelected",function(){y.find(".empty").hide()}),$(".dropdown-menu.selection-opts").find("[data-select-event]").click(function(){var e=$(this).attr("data-select-event");$(document).trigger(e)}),g()});